---
title: "data_analysis_working"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

#! 1) Which packages will I need for this program? 

library(tidyverse)
library(tidycensus)
library(janitor)
library(mapview)
library(ggthemes)
library(scales)
library(arcos)
library(stringr)
library(ggrepel)


# KEYS
census_api_key("6807e6be8b6aeed023ebd2791acda76a66b32754")
arcos_key <- "aoQ1LGl"

# CENSUS DATA VARIABLES 
 
acs_variables <- load_variables(2012, "acs5", cache = TRUE)

options(scipen=999)


```

```{r}

#! 2) What geodata will I need for this program? 

# COUNTY GEODATA 
county_geodata_shifted <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

# STATE GEODATA 
state_geodata_shifted <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

```

```{r}

#! 3) How do I find the median incomes for all counties across the U.S. and more specifically, Maryland? 

#MEDIAN HOUSEHOLD INCOME IN COUNTIES ACROSS U.S. 
NAT_C_MED_INCOME <- get_acs(geography = "county", variables = c("B19013_001"), survey="acs5", year = 2012)

# MARYLAND COUNTIES MEDIAN HOUSEHOLD INCOME 
MD_C_median_income <- NAT_C_MED_INCOME %>%
  filter(str_detect(NAME, "Maryland"))

```

```{r}

#! 4) QUESTION:  Which state has the highest median income?

#STATES MEDIAN HOUSEHOLD INCOME 
state_median_income <- get_acs(geography = "state", variables = "B19013_001", year = 2012) %>%
  arrange(desc(estimate))

# Maryland has the highest median income. 

```

```{r}

#! 5) Which county in Maryland received the most pills per person between 2006 and 2012? 

MD_C_combined_pills <- summarized_county_annual(state="MD", key = arcos_key) %>%
  group_by(BUYER_COUNTY, BUYER_STATE, countyfips) %>%
  summarise(DOSAGE_UNIT = sum(DOSAGE_UNIT)) %>%
  arrange(desc(DOSAGE_UNIT))

# Baltimore County received the most pills per person between 2006 and 2012. 
```

```{r}

# 6) What was the median income in Baltimore between 2006 and 2012? 

nat_counties_median_income %>%
  filter(NAME == "Baltimore city, Maryland")

# Baltimore median income was $40,803. 

```



```{r}


#! 7) Which county in the United States received the most pills total between 2006 and 2012?

nat_counties_pills <- summarized_county_annual(key = arcos_key) 

nat_counties_pills <- nat_counties_pills %>%
  group_by(BUYER_COUNTY, BUYER_STATE) %>%
  summarise(DOSAGE_UNIT = sum(DOSAGE_UNIT)) %>%
  arrange(desc(DOSAGE_UNIT))

# Los Angeles received the most pills total between 2006 and 2012. 

```

```{r}

#! 8)  What was the median income of Los Angeles County in the latest ACS survey? 

nat_counties_median_income %>%
  filter(NAME == "Los Angeles County, California") 

# The average income was 52,241. 
```


```{r}

#! 9)  What county in the U.S. has the highest median income? 

nat_counties_median_income %>% arrange(desc(estimate))

# Falls Church City, Virginia has the highest median income of any county in the country at $122,844.

```

```{r}

#! 10) What county in the U.S. has the lowest median income? 

nat_counties_median_income %>% arrange(desc(estimate)) %>%
  filter(!str_detect(NAME, "Puerto Rico")) %>%
  arrange(estimate)

# Owsley County, Kentucky has the lowest median income of any county in the U.S. with a median incoem of $19,624. 

```

```{r}

#! 11) Which state in the U.S. has the lowest median income? 

STATE_MED_INCOME %>% arrange(estimate)

# Mississippi has the lowest median income at 38,882. 
```

```{r}

#! 12) Is there a trend between state median income and number of pills received in each MD county between 2006 and 2012? 
# Pills relative to median income.  

MD_INCOME_PILLS <- inner_join(MD_C_median_income, MD_C_combined_pills, by = c("GEOID" = "countyfips"))

# LINE GRAPH MARYLAND MEDIAN INCOME RELATIVE TO PILLS SENT 

ggplot(MD_INCOME_PILLS) + 
  geom_point(aes(med_income, DOSAGE_UNIT)) +
  labs(x="Median Income", y = "DOSAGE_UNIT") + 
  geom_text_repel(aes(med_income, DOSAGE_UNIT, label=BUYER_COUNTY)) +
   geom_smooth(aes(med_income, DOSAGE_UNIT), method= 'lm', se = FALSE)

```

```{r}

#! 13) How do I calculate pills per person and add that to my combined dataset?

#BUILDING TABLE TO INCLUDE PILLS PER PERSON 

MD_COUNTY_POP <- NAT_COUNTY_POP %>%
  filter(str_detect(NAME, "Maryland"), variable == "POP") 

MD_INCOME_PILLS <- MD_INCOME_PILLS %>%
  right_join(MD_COUNTY_POP, by = "GEOID") %>%
  select(GEOID, BUYER_COUNTY, estimate, DOSAGE_UNIT, value)

MD_INCOME_PILLS <- MD_INCOME_PILLS %>%
  rename(population = value)

MD_INCOME_PILLS <- MD_INCOME_PILLS %>%
  rename(med_income = estimate)

MD_INCOME_PILLS <- MD_INCOME_PILLS %>%
  mutate(pills_per_person = DOSAGE_UNIT / population)

#! 14) Which county in Maryland distributed the most pills per person between 2006 and 2012?  

# Kent County 

#! 15) What is the median household income of Kent County? 
 
# $54,614


```

```{r}

#! 16) Is there a trend between county median income and the number of pills distributed per person between 2006-2012? 

# LINE PLOT COMPARING MED INCOME VS. PILLS PER PERSON TOTAL BETWEEN 2006-2012

ggplot(MD_INCOME_PILLS) + 
  geom_point(aes(med_income, pills_per_pop)) +
  labs(x="Median Income", y = "Pills Per Person") + 
  geom_text_repel(aes(med_income, pills_per_pop, label=BUYER_COUNTY)) +
   geom_smooth(aes(med_income, pills_per_pop), method= 'lm', se = FALSE)

#! 17) Which county in Maryland distributed the least pills per person between 2006 and 2012? 

## Montgomery County. 

#! 18) What is the median household income of Montgomery County? 

MD_INCOME_PILLS %>%
  select(BUYER_COUNTY, pills_per_pop) %>%
  arrange(pills_per_pop)

## Montgomery County 
```

```{r}

#! 19) How do I build a table that contains that same information but for counties across the country? 

# BUILDING TABLE CONTAINING NATIONAL STATE MEDIAN INCOME VS. PILLS PER PERSON 

NAT_COUNTY_POP <- NAT_COUNTY_POP %>%
  filter(variable == "POP")

NAT_C_INCOME_POP <- inner_join(NAT_COUNTY_POP, NAT_C_MED_INCOME, by = "GEOID") %>%
  select(NAME.x, GEOID, value, estimate)

total_pills <- summarized_county_annual(key = arcos_key)

NAT_COMBINED <- NAT_C_INCOME_POP %>%
  right_join(total_pills, by = c("GEOID" = "countyfips")) %>%
  group_by(BUYER_COUNTY, BUYER_STATE, GEOID, value, estimate) %>%
  summarise(DOSAGE_UNIT = sum(DOSAGE_UNIT)) %>%
  arrange(desc(DOSAGE_UNIT))

NAT_COMBINED <- NAT_COMBINED %>%
  rename(med_income = pop)

NAT_COMBINED <- NAT_COMBINED %>%
  rename(population = value)
```

```{r}

#! 20) How do I calculate the pills per person for the national counties? 

 NAT_COMBINED <- NAT_COMBINED %>%
  mutate(pills_per_person = DOSAGE_UNIT / value)

```

```{r}

#! 21) Why can't I graph the counties the same way? 

## The data is too large and can't plot every county, so in order to build a linear chart like I did in the Maryland map, then I'll need to group by state and then map by median income. 

#! 22) How do I combined everything so I can graph by states?

## I have to make sure every table with a state abbreviation has a state name attached as well. 
  
STATE_COMBINED <- NAT_COMBINED %>%
  select(BUYER_STATE, value, med_income, GEOID, pills_per_person, DOSAGE_UNIT, pills_per_person)

STATE_COMBINED <- left_join(STATE_COMBINED, state_names, by = c("BUYER_STATE" = "abb"))

state_names <- tibble(state = state.name) %>%
   bind_cols(tibble(abb = state.abb)) %>% 
   bind_rows(tibble(state = "District of Columbia", abb = "DC"))

STATE_POP <- state_population(key = arcos_key) %>%
  filter(year == 2012)


STATE_COMBINED <- STATE_COMBINED %>% 
  select(BUYER_COUNTY, BUYER_STATE, state, pills_per_person, DOSAGE_UNIT)%>%
  inner_join(STATE_POP, by = "BUYER_STATE") %>%
  inner_join(STATE_MED_INCOME, by = c("state" = "NAME"))

STATE_COMBINED <- STATE_COMBINED %>%
  group_by(BUYER_STATE, state, GEOID, estimate, population) %>%
  summarise(DOSAGE_UNIT = sum(DOSAGE_UNIT)) %>%
  mutate(pills_per_person = DOSAGE_UNIT / population) %>%
  arrange(desc(pills_per_person))

#! 23) Which state had the most pills per person overall between 2006 and 2012? 

## West Virginia,  between 2006 and 2012, could give 461 pills to each person in their state. 

#! 24) What was the median income of West Virginia, in 2012? 

## 40,400 

#! 25) Which state had the least pills per person overall between 2006 and 2012? 

summary(STATE_COMBINED)

## North Dakota only had enough pills between 2006 and 2012 to give 132 to each person. 

#! 26) What was the median income of North Dakota in 2012? 

## 51,641


```

```{r}

#! 27) Now graph the states relationship between median income and pills per person. 

ggplot(STATE_COMBINED) + 
  geom_point(aes(estimate, pills_per_person)) +
  labs(x="Median Income", y = "Pills Per Person") + 
  geom_text_repel(aes(estimate, pills_per_person, label= BUYER_STATE)) +
   geom_smooth(aes(estimate, pills_per_person), method= 'lm', se = FALSE)

#! 28) Is there a relationship between median income and pills per person? 

## Yes, there is an obvious negative correlation between median income and pills per person. As median income increases, so does the pills per person a state can offer. 

!# 29) Which relationship between income and pills per person is stronger, national or in Maryland? 
  
## The relationship between income and pills is stronger at the national level. 
  
!# 30) Why might the relationship between median income and pills per person be weaker in Maryland than at the national level? 
  
## Maryland has the highest median income in the country and many of our residents are considered wealthy relative to the rest of the country. However, in Maryland, even the wealthy are abusing opiates, like in Harford and Calvert county where there is a greater number of pills per person at higher incomes. 

```

```{r}

# Map out income vs. pills per person at state and national level. 

# Visualize relationship between proximity to Baltimore City and pills per person. 

# Visualize how pharmacies are targeting areas of lower income in the U.S. compared to in Maryland. 

# Establish correlation between income and pills per person. 


```

